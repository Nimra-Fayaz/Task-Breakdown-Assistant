name: CI - Tests & Code Quality

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test-backend:
    name: Test Backend (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ matrix.python-version }}-${{ hashFiles('backend/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-${{ matrix.python-version }}-

      - name: Install dependencies
        working-directory: ./backend
        run: |
          poetry install --no-interaction --no-root

      - name: Run pytest tests
        working-directory: ./backend
        run: |
          poetry run pytest -v --tb=short

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-python-${{ matrix.python-version }}
          path: backend/test-results/
          if-no-files-found: ignore

  lint-backend:
    name: Lint Backend (Ruff & Black)
    runs-on: ubuntu-latest

    steps:
       - name: Checkout code
         uses: actions/checkout@v4

       - name: Set up Python
         uses: actions/setup-python@v5
         with:
           python-version: "3.11"

       - name: Install Poetry
         run: |
           curl -sSL https://install.python-poetry.org | python3 -
           echo "$HOME/.local/bin" >> $GITHUB_PATH

       - name: Install dependencies
         working-directory: ./backend
         run: |
           poetry install --no-interaction --no-root

       - name: Run Ruff linter
         working-directory: ./backend
         run: |
           poetry run ruff check . --output-format=github

       - name: Check code formatting with Black
         working-directory: ./backend
         run: |
           poetry run black --check --verbose .

  secret-detection:
    name: Secret Detection (Gitleaks)
    runs-on: ubuntu-latest

    steps:
       - name: Checkout code
         uses: actions/checkout@v4
         with:
           fetch-depth: 0

       - name: Run Gitleaks
         uses: gitleaks/gitleaks-action@v2
         env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint-frontend:
    name: Lint Frontend (TypeScript/React)
    runs-on: ubuntu-latest

    steps:
       - name: Checkout code
         uses: actions/checkout@v4

       - name: Set up Node.js
         uses: actions/setup-node@v4
         with:
           node-version: "18"
           cache: 'npm'
           cache-dependency-path: frontend/package-lock.json

       - name: Install dependencies
         working-directory: ./frontend
         run: npm ci

      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [test-backend, lint-backend, secret-detection, lint-frontend]
    if: always()

    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.test-backend.result }}" == "success" && \
                "${{ needs.lint-backend.result }}" == "success" && \
                "${{ needs.secret-detection.result }}" == "success" && \
                "${{ needs.lint-frontend.result }}" == "success" ]]; then
            echo "All CI checks passed!"
            exit 0
          else
            echo "Some CI checks failed!"
            echo "Backend Tests: ${{ needs.test-backend.result }}"
            echo "Backend Linting: ${{ needs.lint-backend.result }}"
            echo "Secret Detection: ${{ needs.secret-detection.result }}"
            echo "Frontend Linting: ${{ needs.lint-frontend.result }}"
            exit 1
          fi
